<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
  </style>
</head>
<body>
<h1 id="como-desplegar-una-aplicación-web-en-iaas.ull.es">Como Desplegar una Aplicación Web en <a href="https://iaas.ull.es">iaas.ull.es</a></h1>
<p>Para acceder al servicio, todos los usuarios (tanto los responsables como los usuarios finales) accederán a <a href="https://iaas.ull.es" class="uri">https://iaas.ull.es</a>, donde seleccionarán la opción <strong>Portal del usuario</strong>.</p>
<p>Recuerde que dentro de la ULL deberá haber <strong>entrado previamente a <a href="https://acceso.ull.es" class="uri">https://acceso.ull.es</a></strong>, esto es estar autenticado como miembro de la ULL y desde fuera de la ULL usando la VPN de la ULL</p>
<div class="figure">
<img src="ovirtportal.png" alt="Autenticandose" /><p class="caption">Autenticandose</p>
</div>
<p>Una vez autenticado le saldrá el menú con su panel de máquinas:</p>
<div class="figure">
<img src="panelmaquina.png" alt="Panel de las máquinas" /><p class="caption">Panel de las máquinas</p>
</div>
<p>Al pulsar sobre <code>connect</code> se abrirá una terminal en el navegador:</p>
<div class="figure">
<img src="terminalnavegador.png" alt="Terminal en el navegador" /><p class="caption">Terminal en el navegador</p>
</div>
<h2 id="opciones-de-consola">Opciones de Consola</h2>
<p>Si tiene problemas conectándose a la máquina repase las opciones del campo <code>Console</code>:</p>
<ul>
<li>Se han configurado con el visor VNC (recuerde poner la opción <code>noVNC</code> en las opciones de la cónsola). <a href="https://en.wikipedia.org/wiki/Virtual_Network_Computing">VNC</a> es un sistema para compartir un desktop gráfico</li>
</ul>
<div class="figure">
<img src="novncconsoleoptions.png" alt="Opciones de la Consola" /><p class="caption">Opciones de la Consola</p>
</div>
<h2 id="acceso-por-ssh-y-credenciales">Acceso por SSH y Credenciales</h2>
<ul>
<li><p>Las credenciales son <code>usuario/usuario</code>, se les forzará a cambiar la contraseña ante el primer login.</p></li>
<li><p>Las máquinas tienen IP dinámica por DHCP (en principio tienen keepalive así que no debería cambiarlas)</p></li>
<li><p>Los usuarios tienen disponibilidad para hacer SSH a las máquinas,</p>
<ol style="list-style-type: decimal">
<li>dentro de la ULL <strong>entrando previamente a <a href="https://acceso.ull.es" class="uri">https://acceso.ull.es</a></strong> y</li>
<li>desde fuera de la ULL usando la VPN</li>
</ol></li>
</ul>
<p>Serán requeridas las credenciales de la ULL; es decir, este servicio será exclusivo para la comunidad universitaria</p>
<h2 id="averiguar-la-ip-de-la-máquina-virtual">Averiguar la IP de la máquina virtual</h2>
<ul>
<li>La terminal en el navegador no es útil en absoluto.</li>
<li>Use la terminal en el navegador para averiguar la IP de la máquina para poder usar <code>ssh</code> posteriormente. En la terminal de su navegador conectado a la máquina escriba:</li>
</ul>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">usuario@SYTW</span>:~/src/sytw$ ifconfig
<span class="kw">eth0</span>      Link encaa:Ethernet  direcciónHW aa:aa:aa:aa:aa:aa  
          <span class="kw">Direc.</span> inet:55.5.555.55</code></pre>
<ul>
<li>La IP es el valor que aparece en el campo <code>inet</code></li>
<li>A partir de ese momento use el cliente <code>ssh</code> en su ordenador para conectarse a su máquina virtual</li>
</ul>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">ssh</span> 55.5.555.55</code></pre>
<h2 id="vpn-ull">VPN ULL</h2>
<p>Tutorial sobre como usar el <a href="https://usuarios.ull.es/vpn/">Servicio VPN de la ULL</a></p>
<h2 id="configure-la-ssh-de-su-portátildesktop-para-acceder-a-su-máquina-del-iaas">Configure la ssh de su portátil/desktop para acceder a su máquina del iaas</h2>
<ol style="list-style-type: decimal">
<li>Genere una clave rsa en su portátil (limitación en 2018: tiene que ser rsa)</li>
</ol>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">~</span>/<span class="kw">.ssh</span>(master)]$ <span class="kw">ssh-keygen</span> -trsa
<span class="kw">Generating</span> public/private rsa key pair.
<span class="kw">Enter</span> file in which to save the key (/Users/casiano/.ssh/id_rsa)<span class="kw">:</span> miclave
<span class="kw">Enter</span> passphrase (empty for no passphrase)<span class="kw">:</span>
<span class="kw">Enter</span> same passphrase again:
<span class="kw">Your</span> identification has been saved in miclave.
<span class="kw">Your</span> public key has been saved in miclave.pub.</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>Añada una entrada en su fichero <code>~/.ssh/config</code>:</li>
</ol>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># PL 17/18</span>
<span class="co"># iaas.ull.es</span>
<span class="kw">Host</span> pl1718
<span class="kw">HostName</span> 11.1.111.111
<span class="kw">user</span> usuario
<span class="kw">IdentityFile</span> /Users/casiano/.ssh/miclave
<span class="co">## send the signal every four minutes</span>
<span class="kw">ServerAliveInterval</span> 240</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>Publique la clave en su máquina <code>iaas</code></li>
</ol>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">usuario@ubuntu</span>:~/.ssh$ cd .ssh/
<span class="kw">usuario@ubuntu</span>:~/.ssh$ vi authorized_keys</code></pre>
<p>añada los contenidos de <code>miclave.pub</code></p>
<h2 id="referencias">Referencias</h2>
<ul>
<li><p>El tutorial <a href="https://casianorodriguezleon.gitbooks.io/ull-esit-1617/content/recursos/iaas.html">SERVICIO IAAS de la ULL</a></p></li>
<li><p>Véase <a href="https://sytw.github.io/iaas-ull-es/index.html">este documento como HTML</a></p></li>
<li><p>Véase este <a href="https://github.com/SYTW/iaas-ull-es">repo en GitHub</a></p></li>
<li><p>Lea el documento <a href="manualDeAdministracionDelPoolsDeMaquinas.pdf">&quot;Manual de administración de Pools de máquinas&quot;</a>.</p></li>
</ul>
<h2 id="puertos-abiertos-en-las-máquinas-virtuales">Puertos abiertos en las Máquinas Virtuales</h2>
<ul>
<li>Creo que ahora mismo las Máquinas Virtuales vienen con estos puertos abiertos:</li>
<li>22, 80, 443 y</li>
<li>el rango del 8080 al 8090</li>
</ul>
<h2 id="descripción-de-las-máquinas">Descripción de las máquinas</h2>
<ul>
<li>En principio se dispone de una máquina por alumno</li>
<li>Las máquinas de una misma asignatura comparten el mismo <em>tag</em>, por ejemplo <code>SISTECWEB</code> o algo parecido</li>
<li>Las máquinas tienen 2GB de RAM y 1 procesador de 2 CPUs cada una</li>
</ul>
<h3 id="que-suele-estar-instalado">Que suele estar instalado</h3>
<p>Lo que está instalado en las máquinas depende del tipo de plantilla que haya solicitado el profesor para el curso. De todos modos, como tenemos permisos de administración no es mucho problema instalar cualquier software que nos falte.</p>
<p>Lo que sigue es la descripción de una máquina típica correspondiente a una plantilla <em>de servidor</em>.</p>
<ul>
<li><p>Suele estar instalado <code>git</code>:</p>
<pre><code>          usuario@SYTW:~$ git --version
          git version 1.9.1</code></pre></li>
</ul>
<p>Si queremos actualizar <code>git</code>:</p>
<pre class="sh"><code>apt-get install git</code></pre>
<ul>
<li><p>Suele estar instalado <code>nodejs</code>. Recuerde que es Linux Ubuntu: <code>node</code> no es <code>nodejs</code>:</p>
<pre><code>    usuario@SYTW:~$ node --version
    El programa «node» puede encontrarse en los siguientes paquetes:
     * node
     * nodejs-legacy
    Intente: sudo apt-get install &lt;paquete seleccionado&gt;

    usuario@SYTW:~$ nodejs --version
    v0.10.25</code></pre></li>
</ul>
<p>Si no está instalado siga las instrucciones en <a href="https://nodejs.org/en/download/package-manager/">Installing Node.js via package manager</a> <code>bash   curl -sL https://deb.nodesource.com/setup_7.x | sudo -E bash -   sudo apt-get install -y nodejs</code> * <em>Haga un enlace simbólico</em> de <code>node</code> a <code>node.js</code> <code>bash   usuario@ubuntu:~$ which nodejs   /usr/bin/nodejs   usuario@ubuntu:~$ sudo ln -s /usr/bin/nodejs /usr/bin/node   usuario@ubuntu:~$ node --version   v4.2.6</code> * O mejor aún instale primero <a href="https://github.com/creationix/nvm">nvm</a> y luego instale Node.js. nvm es como rvm para NodeJS: Te permite tener varias instalaciones de node y cambiar entre versión y versión</p>
<p><code>bash   usuario@ubuntu:~$ curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.8/install.sh | bash</code> El script clona el repositorio de nvm a <code>~/.nvm</code> y añade líneas a nuestro script de arranque de perfil (<code>~/.bash_profile</code>, <code>~/.zshrc</code>, <code>~/.profile</code>, or <code>~/.bashrc</code>). Es por eso que tenemos que rearrancar la terminal:</p>
<p><code>bash   usuario@ubuntu:~$ command -V nvm   -bash: command: nvm: no se encontró   usuario@ubuntu:~$ bash   usuario@ubuntu:~$ nvm list               N/A   node -&gt; stable (-&gt; N/A) (default)   iojs -&gt; N/A (default)</code> Podemos ahora instalar tantas versiones de node como queramos: <code>bash   usuario@ubuntu:~$ nvm install node   Downloading and installing node v9.4.0...   usuario@ubuntu:~$ nvm list   -&gt;       v9.4.0   default -&gt; node (-&gt; v9.4.0)   node -&gt; stable (-&gt; v9.4.0) (default)   stable -&gt; 9.4 (-&gt; v9.4.0) (default)   iojs -&gt; N/A (default)   lts/* -&gt; lts/carbon (-&gt; N/A)   lts/argon -&gt; v4.8.7 (-&gt; N/A)   lts/boron -&gt; v6.12.3 (-&gt; N/A)   lts/carbon -&gt; v8.9.4 (-&gt; N/A)</code></p>
<h2 id="configure-el-cliente-ssh-para-trabajar-con-github">Configure el cliente ssh para trabajar con GitHub</h2>
<ul>
<li><p>Recuerde poner sus claves privadas de GitHub en <code>.ssh</code> para poder trabajar con sus repos</p></li>
<li><p>Actualice <code>~/.ssh/config</code> de manera apropiada:</p>
<pre><code>    usuario@SYTW:~/src/sytw$ cat ~/.ssh/config
    Host github.com
    HostName github.com
    user git
    IdentityFile /home/usuario/.ssh/miclaveparagithub</code></pre></li>
</ul>
<h2 id="descargando-un-repo">Descargando un repo</h2>
<ul>
<li><p>Cree un directorio de trabajo:</p>
<pre><code>  usuario@SYTW:~$ mkdir src
  usuario@SYTW:~$ cd src
  usuario@SYTW:~/src$ mkdir sytw
  usuario@SYTW:~/src$ cd sytw/</code></pre></li>
<li><p>Clone un repo con una aplicación Web de prueba. Por ejemplo <a href="https://github.com/crguezl/express-start">crguezl/express-start</a>:</p>
<pre><code>  usuario@SYTW:~/src/sytw$ git clone git@github.com:crguezl/express-start.git
  Clonar en «express-start»...
  Warning: Permanently added the RSA host key for IP address &#39;555.55.555.555&#39;
           to the list of known hosts.
  remote: Counting objects: 87, done.
  remote: Total 87 (delta 0), reused 0 (delta 0), pack-reused 87
  Receiving objects: 100% (87/87), 66.93 KiB | 0 bytes/s, done.
  Resolving deltas: 100% (41/41), done.
  Checking connectivity... hecho.</code></pre></li>
<li><p>Este es el contenido de la aplicación de ejemplo <a href="https://github.com/crguezl/express-start/blob/master/hello/hello.js">hello.js</a>:</p>
<pre><code>    usuario@SYTW:~/src/sytw/express-start$ cd hello/

    usuario@SYTW:~/src/sytw/express-start/hello$ vi hello.js
    usuario@SYTW:~/src/sytw/express-start/hello$ # cambiamos port de escucha a 80

    usuario@SYTW:~/src/sytw/express-start/hello$ cat hello.js</code></pre>
<p>```javascript var express = require('express') var app = express() var path = require('path');</p></li>
</ul>
<p>// view engine setup app.set('views', path.join(__dirname, 'views')); app.set('view engine', 'ejs');</p>
<p>app.use(express.static('public'));</p>
<p>app.get('/', function (req, res) { //res.send('Hello World!') res.render('index', { title: 'Express' }); })</p>
<p>/<em> var router = express.Router(); module.exports = router; </em>/ app.get('/chuchu', function (req, res) { //res.send('Hello Chuchu!') res.render('index', { title: 'Chuchu' }); })</p>
<p>app.get('/cat', function (req, res) { res.send('Got a GET request'+ '<br/><img src="kitten.jpg" />' ); })</p>
<p>app.get('/dog', function (req, res) { res.sendFile(path.join(__dirname, 'public/dog.jpg')); });</p>
<p>var server = app.listen(8080, function () {</p>
<p>var host = server.address().address var port = server.address().port</p>
<p>console.log('Example app listening at http://%s:%s', host, port)</p>
<p>}) ```</p>
<h2 id="instalando-dependencias">Instalando dependencias</h2>
<ul>
<li><p>Instalamos las dependencias:</p>
<pre><code>    usuario@SYTW:~/src/sytw/express-start/hello$ npm install
    npm WARN package.json hello@0.0.0 No description
    npm WARN package.json hello@0.0.0 No repository field.
    ...</code></pre></li>
</ul>
<h2 id="ejecución-de-un-servicio">Ejecución de un servicio</h2>
<ul>
<li><p>Ejecutamos (El <code>sudo</code> es necesario porque estamos usando el puerto 80):</p>
<pre><code>    usuario@SYTW:~/src/sytw/express-start/hello$ sudo nodejs hello.js
    Example app listening at http://0.0.0.0:80</code></pre></li>
<li><p>Usamos el comando unix <a href="http://linux.101hacks.com/unix/nohup-command/"><code>nohup</code></a> si queremos evitar que el programa termine cuando hagas logout</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">usuario@ubuntu</span>:~/src/express-start/hello$ nohup sudo -b node hello.js</code></pre>
La opción <code>-b</code> de <a href="https://www.sudo.ws/man/1.8.13/sudo.man.html"><code>sudo</code></a> ejecuta el comando en background. Ahora podemos salir de la cuenta y el servicio continúa ejecutandose.</li>
<li><p>A continuación visitamos la página con el navegador usando la URL con la IP:</p></li>
</ul>
<div class="figure">
<img src="browser.png" alt="Visitando con el navegador la página" /><p class="caption">Visitando con el navegador la página</p>
</div>
</body>
</html>
